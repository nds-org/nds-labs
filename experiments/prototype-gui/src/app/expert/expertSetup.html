<section>
  <div>
    <div class="row">
      <div class="col-sm-12">
       <div class="jumbotron" style="padding-left:15px;">
         <div class="row">
           <div class="col-sm-10">
             <h3><small class="text-muted">PROJECT</small>&nbsp;&nbsp;&nbsp;{{ project.namespace | capitalize }}</h3>
            <!-- <h4>{{ app.tagline }}</h4> -->
           </div>
           <div class="col-sm-2" style="height:100%;vertical-align:middle;margin:auto;">
             <div class="pull-right">
                <!-- Top-Right Button Bar if we want any -->
                <button class="btn btn-default btn-sm" ng-click="softRefresh()"
                     ng-mouseenter="iconSpin = true" ng-mouseleave="iconSpin = false"
                     uib-tooltip="Refresh the data on this page" tooltip-placement="left">
                   <i class="fa fa-refresh fa-fw" ng-class="{ 'fa-spin':iconSpin }"></i>
                </button>
              </div>
            </div>
         </div>
      </div>
    </div>
    
    <!-- Left Half (Selector Pane) -->
    <div style="margin-top:15px;" ng-cloak>
      <div class="row" style="display:table-row;">
        <div class="col-sm-3" style="display:table-cell;">
          <div class="panel panel-default" >
            <div class="panel-body" style="padding:0;">
              <div class="input-group">
                <span class="input-group-addon" id="searchHeader"><i class="fa fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Find Services..." ng-model="svcQuery" 
                    aria-describedby="searchHeader" />
              </div>
              
              <p class="text-center text-danger" ng-if="(allServices | filter : svcQuery).length === 0">
                <small>No services matched the specified query</small>
              </p>
            </div>
            
            <table class="table table-condensed" 
                ng-hide="(allServices | filter : svcQuery).length === 0">
              <tbody>
                <tr ng-repeat="stack in allServices | orderBy:'key' | filter : svcQuery track by stack.key">
                  <td width="95%">{{ stack.label }}</td>
                  <td width="5%">
                   <button class="btn btn-xs btn-default" ng-click="openWizard(stack)" 
                         uib-tooltip="{{ stack.description }}" tooltip-placement="right">
                      <i class="fa fa-plus"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
       
        <!-- Right Half (Content Pane) -->
        <div class="col-sm-9 fill-height" style="display:table-cell;" ng-cloak>
          <div class="">
            
            <div class="panel-body" style="padding:0;">
              
              <!-- Tabs for Stacks / Volumes -->
              <uib-tabset active="selectedTab" type="pills" style="border-radius:0px;">
                
                <!-- Configured Stacks --> 
                <uib-tab index="0">
                  <uib-tab-heading>
                    <i class="fa fa-fw fa-align-justify"></i> Stacks
                  </uib-tab-heading>
                  <div class="well well-lg fill-height" style="border-radius:0px;margin:0">
                    <!-- Helper text to display if the user has no yet configured any stacks -->
                    <div ng-if="configuredStacks.length === 0" class="helper-text">
                      <h2>It looks like you haven't configured any stacks.</h2>
                      <h4>Search and add a stack of services to see and manage it here!</h4>
                    </div>
                    
                    <!-- The Accordion of Configured Stacks -->
                    <uib-accordion ng-if="configuredStacks.length > 0" close-others="true">
                      
                      <!-- TODO: This is a silly hack, since we can't bind to the accordion's panel-class attribute, \
                      and we apparently cannot use ng-class to do the same thing, due to an implementation detail. -->
                      <!-- See https://github.com/angular-ui/bootstrap/issues/5368 -->
                      <uib-accordion-group ng-repeat="stack in configuredStacks | orderBy:'name' track by stack.id" is-open="open" 
                          class="{{ stack.status === 'started' ? 'panel-success' : (stack.status === 'stopped' ? 'panel-danger' : 'panel-warning')  }}">
                        <uib-accordion-heading>
                          <!--- ng-class="{ 'panel-success': stack.status === 'started', 'panel-danger': stack.status === 'stopped', 'panel-warning':stack.status !== 'started' && stack.status !== 'stopped' }" -->
                          <!-- Stack Status Indicator -->
                          <div class="row">
                            <div class="col-sm-1 pull-left">
                              <i class="fa fa-fw fa-2x" 
                                ng-class="{ 'fa-check-circle-o text-success': stack.status === 'started', 
                                    'fa-times-circle-o text-danger': stack.status === 'stopped',
                                    'fa-spinner fa-spin fa-pulse text-primary': stack.status !== 'started' && stack.status !== 'stopped' }"></i>
                            </div>
                            <div class="col-sm-10">
                              <h4>{{ stack.name | capitalize}}</h4>
                            </div>
                            <div class="col-sm-1" style="vertical-align:middle;">
                              <i class="pull-right fa fa-2x fa-fw" ng-class="{'fa-caret-down': open, 'fa-caret-right': !open}"></i>
                            </div>
                          </div>
                        </uib-accordion-heading> 
                          
                        <!-- Stack Services -->
                        <div class="row">
                          <div class="col-sm-12">
                            <!-- List off our stack's services here -->
                            <div class="table-responsive">
                              <table class="table table-striped table-hover">
                                <thead>
                                  <tr>
                                   <!-- <td width="10%" class="text-center"><strong>Status</strong></td> -->
                                   <!-- <td width="10%" class="text-center"><strong>Links</strong></td> -->
                                    <td width="10%" class="text-center"><strong>Status</strong></td>
                                    <td width="10%" class="text-center"><strong>Volumes</strong></td>
                                    <td width="60%"><strong>Name</strong></td>
                                    <td width="20%" class="text-center">
                                      <strong ng-if="stack.status === 'started' || intervals.start[stack.id]">Logs</strong>
                                      <strong ng-if="stack.status === 'stopped' && !intervals.start[stack.id]">Remove</strong>
                                    </td>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr ng-repeat="svc in stack.services track by svc.service">
                                    
                                    <td class="text-center">
                                      <i class="fa fa-fw" ng-class="{ 'fa-gear fa-spin text-info': svc.status === 'Pending',
                                                                      'fa-check text-success': svc.status === 'Running',
                                                                      'fa-power-off text-danger': svc.status === ''}"></i>
                                      {{  svc.status || 'Stopped' }}
                                    </td>
                                    
                                    <!--ng-class="{ 'danger':svc.status === '', 'success':svc.status === 'Running', 'warning': svc.status === 'Pending' }">-->
                                    <!-- Volume details for this service -->
                                    <td class="text-center">
                                      <button class="btn btn-link btn-xs" tooltip-placement="left" 
                                          uib-tooltip='Click here for details regarding "{{ volume.name }}"'                                          ng-click="selectVolume(volume);"
                                          ng-repeat="volume in svc.id | stackSvcVolumes track by volume.id"
                                          >
                                        <!-- show volume details if we find a volume -->
                                        <i class="fa fa-fw fa-database" style="cursor:pointer;"></i>
                                      </button>
                                    </td>
                                    
                                    <!-- The Name of the Running Service and link to endpoint, if applicable -->
                                    <td>
                                      <span ng-if="stack.status !== 'started' || !svc.endpoints || svc.endpoints.length === 0 || svc.endpoints[0] === ''">{{ svc.service | specProperty:'label' }}</span>
                                      
                                      <a ng-repeat="endpt in svc.endpoints track by $index" uib-tooltip="Navigate to {{ svc.service | capitalize }} ({{ endpt }})"
                                          ng-if="(stack.status === 'started') && svc.status === 'Running' 
                                              && svc.endpoints.length > 0 && svc.endpoints[0] !== ''"  target="_blank"
                                          href="{{ endpt }}" ng-disabled="stack.status === 'stopping' && svc.status === 'Running'">
                                        {{ svc.service | specProperty:'label' }}&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-fw fa-external-link faa-tada faa-slow animated"></i>
                                      </a>
                                      
                                      <a type="button" class="btn btn-link btn-xs" ng-if="$index !== 0" ng-repeat="endpt in svc.endpoints track by $index" uib-tooltip="Navigate to {{ svc.service | capitalize }} ({{ endpt }})"
                                          ng-if="svc.status === 'Running' && svc.endpoints.length > 0 && svc.endpoints[0] !== ''"
                                          href="{{ endpt }}" target="_blank" ng-disabled="svc.status !== 'Running'">
                                        <i class="fa fa-fw fa-external-link faa-tada faa-slow animated"></i>
                                      </a>
                                    </td>
                                    
                                    <!-- View Logs of Running Service, or Remove Stopped Service -->
                                    <td class="text-center">
                                      <!-- View logs button -->
                                      <button type="button" class="btn btn-xs btn-default" 
                                      uib-tooltip="View {{ svc.service | specProperty:'label' }} Logs" 
                                      ng-if="stack.status.indexOf('start') !== -1 || intervals.start[stack.id]"
                                      ng-disabled="svc.status === ''" tooltip-placement="left" ng-click="showLogs(svc)">
                                        <i class="fa fa-fw fa-file-text" ng-class="{ 'animated faa-vertical': stack.status === 'starting' && svc.status === 'Pending' }"></i>
                                      </button>
                                      
                                      <!-- Remove service from stack button -->
                                      <button type="button" ng-disabled="stack.services | isRecursivelyRequired:svc" 
                                          ng-if="(stack.status === 'stopped' && !intervals.start[stack.id]) && svc.service !== stack.key && !_.find((stack.key | requirements), [ 'key', svc.service ])" 
                                          class="btn btn-xs btn-default" ng-click="removeStackSvc(stack, svc)" 
                                          uib-tooltip="Remove {{ option.key | specProperty:'label' }} from this stack" tooltip-placement="left">
                                        <i class="fa fa-fw fa-times"></i>
                                      </button>
                                    </td>
                                  </tr>
                                  
                                  <!-- Add an artificial row (if necessary) for optional services -->
                                  <tr ng-repeat="option in stack.key | options track by option.key"
                                      ng-if="stack.status === 'stopped' && !_.find(stack.services, [ 'service', option.key ])">
        
                                    <td class="text-center">
                                      <button class="btn btn-xs btn-block btn-default" ng-click="addStackSvc(stack, option)"
                                        uib-tooltip="Add {{ option.key | specProperty:'label' }} to this stack"
                                        tooltip-placement="right">
                                        <i class="fa fa-fw fa-plus-circle"></i> Add Service
                                      </button>
                                    </td>
                                    <td></td>
                                    <td>
                                      {{ option.key | specProperty:'label'}}
                                    </td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                        
                        <!-- The Stack's "Button Bar" -->
                        <div class="pull-right" role="group" aria-label="...">
                      
                          <!-- Delete Stack Button -->
                          <button class="btn btn-sm btn-default" ng-disabled="intervals.stop[stack.id] || intervals.start[stack.id]" ng-if="stack.status.indexOf('start') === -1"
                              ng-click="deleteStack(stack)" uib-tooltip="Delete this Stack"
                              tooltip-placement="left">
                            <i class="fa fa-times"></i>
                            Delete Stack
                          </button>
                          
                          <!-- Launch Stack Button -->
                          <button class="btn btn-sm btn-success" ng-disabled="intervals.stop[stack.id] || intervals.start[stack.id]" 
                               ng-click="startStack(stack)" ng-if="stack.status.indexOf('start') === -1" uib-tooltip="Start all services in this stack"
                              tooltip-placement="top">
                            <i class="fa fa-fw fa-play"></i>
                            Launch Stack
                          </button>
                      
                          <!-- Stop Stack Button -->
                          <button class="btn btn-sm btn-danger" ng-disabled="intervals.stop[stack.id] || intervals.start[stack.id]" 
                               ng-click="stopStack(stack)" ng-if="stack.status.indexOf('stop') === -1" uib-tooltip="Stop all services in this stack"
                              tooltip-placement="left">
                            <i class="fa fa-fw fa-stop"></i>
                            Stop Stack
                          </button>
                        </div>
                      </uib-accordion-group>
                    </uib-accordion>
                  </div>
                </uib-tab>
                
                <!-- Configured Volumes -->
                <uib-tab index="1">
                  <uib-tab-heading style="border-radius:0px;">
                    <i class="fa fa-fw fa-database"></i> Volumes
                  </uib-tab-heading>
                  
                  <div class="well well-lg" style="margin:0;border-radius:0px;">
                    <!-- Helper text to display if the user has no yet configured any volumes -->
                    <div ng-if="configuredVolumes.length === 0" class="helper-text">
                      <h2>It looks like you haven't configured any volumes.</h3>
                      <h4>Once you add a stack, its volumes will appear here!</h4>
                    </div>
                    
                    <!-- Slide-Out Panel Contents -->
                    <div class="table-responsive">
                      <table class="table table-hover" ng-if="configuredVolumes.length > 0" 
                          style="border-radius:25px;border:1px solid lightgray;">
                        <thead>
                          <tr>
                            <td width="20%"><strong>Name</strong></td>
                            <td width="20%"><strong>Type</strong></td>
                            <td width="20%" class="text-center"><strong>Size</strong></td>
                            <td width="30%"><strong>Status</strong></td>
                            <td width="10%" class="text-center"><strong>Delete</strong></td>
                          </tr>
                        </thead>
                        <tbody>
                          <tr ng-repeat="volume in configuredVolumes | orderBy:'name' track by volume.id" 
                              style="background:white;" ng-class="{ 'info':volume.id===selectedVolume.id }">
                            <td>{{ volume.name }}</td>
                            
                            <td>{{ volume.service | specProperty:'label' }}</td>
                            
                            <td class="text-center">{{ volume.size }} {{ volume.sizeUnit }}</td>
                            
                            <!-- TODO: Detattaching a volume still shows status as 'attached' -->
                            <!--<td>{{ volume.status }}</td>-->
                            <td>{{ volume.attached ? 'Attached to ' + (volume.attached | stackProperty:'name') : 'Detattached' }}</td>
                            
                            <td class="text-center">
                              <button class="btn btn-xs btn-danger faa-parent animated-hover" ng-if="!volume.attached" ng-click="deleteVolume(volume)"
                                  uib-tooltip="Destroy all Data on this Volume?" tooltip-placement="left">
                                <i class="fa fa-fw fa-bomb animated-hover faa-fast faa-burst"></i>
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </uib-tab>
              </uib-tabset>
            </div>
          </div>
          
          
        </div>
      </div>
    </div>
  </div>
</section>
